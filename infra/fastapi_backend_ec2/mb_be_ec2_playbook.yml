- name: Launch and configure fastAPI backend server
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    stack_name: "moneyBall-backend-ec2"
    template_file: "mb_be_ec2_template.yml"
    instance_type: "t3.medium" # GPU instance
    ami_id: "ami-0ecb62995f68bb549" # Ubuntu Server 24.04 LTS (HVM),EBS General Purpose (SSD) Volume Type
    key_pair_name: "dl_c5_ssh" # Replace with your EC2 Key Pair name

  tasks:
    - name: Launch CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        state: present
        region: "us-east-1" # Specify your AWS region
        template: "{{ template_file }}"
        template_parameters:
          InstanceType: "{{ instance_type }}"
          KeyPairName: "{{ key_pair_name }}"
          AmiId: "{{ ami_id }}"
      register: stack_output

    - name: Get instance public IP from stack output
      set_fact:
        instance_public_ip: "{{ stack_output.stack_outputs.InstancePublicIp }}"

    - name: Add new instance to inventory
      add_host:
        name: "{{ instance_public_ip }}"
        groups: toxic_comment_instances_backend
        ansible_user: "ubuntu" # Default user for Amazon Linux AMIs
        ansible_ssh_private_key_file: "{{ key_pair_name }}.pem"


    - name: Pause for 30 seconds
      ansible.builtin.pause:
        seconds: 30

- name: Configure the instance
  hosts: toxic_comment_instances_backend
  become: yes
  gather_facts: yes

  tasks:

    - name: Install python3-venv
      become: yes
      apt:
        name: python3-venv
        state: present
        update_cache: yes
    
    - name: copy requirements.txt to instance
      copy:
        src: requirements.txt
        dest: /home/ubuntu/requirements.txt

    - name: Create virtual environment
      command: python3 -m venv /home/ubuntu/venv
      args:
        creates: /home/ubuntu/venv/bin/activate
  
    - name: Install python dependencies in venv
      pip:
        requirements: /home/ubuntu/requirements.txt
        virtualenv: /home/ubuntu/venv

    - name: Ensure ubuntu owns the venv
      file:
          path: /home/ubuntu/venv
          owner: ubuntu
          group: ubuntu
          state: directory
          recurse: yes
      
    - name: Install Required Packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present
        update_cache: true
  
    - name: Add Dockerâ€™s official GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: latest
        update_cache: true

    - name: Ensure Docker service is enabled and running
      service:
        name: docker
        enabled: yes
        state: started

    - name: Add current user to docker group (optional)
      user:
        name: ubuntu
        groups: docker
        append: yes
    
    - name: Install unzip
      apt:
        name: unzip
        state: present
        update_cache: yes

    - name: Download AWS CLI v2
      get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'

    - name: Unzip AWS CLI
      unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp/
        remote_src: yes

    - name: Install AWS CLI
      command: sudo /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

    - name: Authenticate Docker to ECR
      shell: |
        aws ecr get-login-password --region us-east-1 |
        docker login --username AWS --password-stdin 703758696118.dkr.ecr.us-east-1.amazonaws.com

    - name: Pull backend Docker image from ECR
      docker_image:
        name: 703758696118.dkr.ecr.us-east-1.amazonaws.com/backend
        source: pull

    - name: Retrieve W&B API key from Secrets Manager via AWS CLI
      command: >
        aws secretsmanager get-secret-value
        --secret-id wandb_api_key
        --region us-east-1
        --query SecretString
        --output text
      register: wandb_secret

    - name: Create .env file for Docker
      copy:
        dest: /home/ubuntu/backend.env
        content: |
          WANDB_API_KEY={{ wandb_secret.stdout }}
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Run Docker container with .env
      community.docker.docker_container:
        name: backend
        image: 703758696118.dkr.ecr.us-east-1.amazonaws.com/backend:latest
        env_file: /home/ubuntu/backend.env
        ports:
          - "8000:8000"
        state: started

